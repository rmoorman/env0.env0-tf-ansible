version: 1

deploy:
  steps:
    terraformApply:
      after:
        - terraform output -raw private_key > /tmp/myKey.pem
        - sudo chmod 400 /tmp/myKey.pem
        - sed -i "s/<placeholder_app>/$(terraform output -raw public_ip)/g" Ansible/inventory
        - sudo apk update
        - sudo apk install ansible
        - cd Ansible
        - ansible-playbook --private-key /tmp/myKey.pem -i inventory jenkinsPlaybook.yaml